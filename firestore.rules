
/**
 * @file Firebase Security Rules for Venue Vendors Firestore Database
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-related data (Users, Clients, Vendors).
 * Categories and Suggested Categories are publicly readable, but only users can create Suggested Categories.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Accessible only to the user themselves.
 * - /users/{userId}/client: Stores client profiles. Accessible only to the user themselves.
 * - /vendors/{vendorId}: Public vendor profiles. Publicly readable, owner-writeable.
 * - /vendors/{vendorId}/services/{serviceId}: Public services. Publicly readable, owner-writeable.
 * - /categories/{categoryId}: Stores vendor categories. Publicly readable.
 * - /suggested_categories/{suggestedCategoryId}: Stores user-submitted category suggestions. Publicly readable, owner-writeable.
 *
 * Key Security Decisions:
 * - Users can only access their own data under the /users/{userId} path.
 * - Public read access is granted to /vendors, /vendors/{vendorId}/services, and /categories.
 * - Write access to vendor data is restricted to the owning user.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    
      match /client/{document=**} {
        allow read, write: if isOwner(userId);
      }
    }

    match /vendors/{vendorId} {
      allow get, list: if true;
      allow create, update: if isOwner(vendorId); // Only owner can create/update their public profile
      allow delete: if false; // Disallow deleting public profiles for now

      match /services/{serviceId} {
        allow get, list: if true;
        allow create, update, delete: if isOwner(vendorId); // Only vendor owner can manage services
      }
    }

    match /categories/{categoryId} {
      allow get, list: if true;
      allow create, update, delete: if false; // Admin-only
    }

    match /suggested_categories/{suggestedCategoryId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
  }
}
